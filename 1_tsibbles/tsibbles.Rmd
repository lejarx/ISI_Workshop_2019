---
title: "High dimensional time series analysis"
date: "robjhyndman.com/hdtsa"
author: "1. Tidy time series tsibbles"
toc: true
output:
  binb::monash:
    colortheme: monashwhite
    fig_width: 7
    fig_height: 3.5
    includes:
      in_header: ../header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE,
  dev.args = list(pointsize = 11)
)
options(digits = 3, width = 60)
library(fpp3)
global_economy <- global_economy %>%
  select(Year, Country, GDP, Imports, Exports, Population)
tourism <- tourism %>%
  mutate(
    State = recode(State,
                   "Australian Capital Territory" = "ACT",
                   "New South Wales"="NSW",
                   "Northern Territory" = "NT",
                   "Queensland" = "QLD",
                   "South Australia" = "SA",
                   "Tasmania" = "TAS",
                   "Victoria"="VIC",
                   "Western Australia" = "WA"
    )
  )
```

# Time series data and tsibbles

## Tidyverts packages

\begin{textblock}{3.8}(8,0)\begin{alertblock}{}\Large\textbf{tidyverts.org}\end{alertblock}\end{textblock}

\placefig{1}{1.4}{width=4cm}{tsibble.png}
\placefig{5}{1.4}{width=4cm}{tsibbledata.png}
\placefig{3}{4.85}{width=4cm}{feasts.png}
\placefig{7}{4.85}{width=4cm}{fable.png}



## Time series data

  - Four-yearly Olympic winning times
  - Annual Google profits
  - Quarterly Australian beer production
  - Monthly rainfall
  - Weekly retail sales
  - Daily IBM stock prices
  - Hourly electricity demand
  - 5-minute freeway traffic counts
  - Time-stamped stock transaction data

## Class packages
\fontsize{13}{14}\sf

```r
# Data manipulation and plotting functions
library(tidyverse)
# Time series manipulation
library(tsibble)
# Forecasting functions
library(fable)
# Time series graphics and statistics
library(feasts)
# Tidy time series data
library(tsibbledata)
```

\pause

```r
# Almost all of the above
library(fpp3)
```

## `tsibble` objects

\fontsize{10}{11.2}\sf

```{r, echo = TRUE}
global_economy
```

\only<2->{\begin{textblock}{.75}(2.15,3.7)
\begin{alertblock}{}\fontsize{10}{10}\sf Index\phantom{dg}\end{alertblock}
\end{textblock}}
\only<3->{\begin{textblock}{1.6}(3.28,3.7)
\begin{alertblock}{}\fontsize{10}{10}\sf Key\phantom{dg}\end{alertblock}
\end{textblock}}
\only<4>{\begin{textblock}{6.7}(5.5,3.7)
\begin{alertblock}{}\fontsize{10}{10}\sf Measured variables\phantom{dg}\end{alertblock}
\end{textblock}}


## `tsibble` objects

\fontsize{10}{11.3}\sf

```{r, echo = TRUE}
tourism
```

\only<2->{\begin{textblock}{1.1}(2.1,3.7)
\begin{alertblock}{}\fontsize{10}{10}\sf Index\phantom{dg}\end{alertblock}
\end{textblock}}
\only<3->{\begin{textblock}{3.9}(3.65,3.7)
\begin{alertblock}{}\fontsize{10}{10}\sf Keys\phantom{dg}\end{alertblock}
\end{textblock}}
\only<4-5>{\begin{textblock}{1.5}(7.95,3.7)
\begin{alertblock}{}\fontsize{10}{10}\sf Measure\phantom{dg}\end{alertblock}
\end{textblock}}

\only<5>{\begin{textblock}{3}(9,5)
\begin{block}{}\fontsize{10}{10}\sf Domestic visitor nights in thousands by state/region and purpose.\phantom{dg}\end{block}
\end{textblock}}


## `tsibble` objects

* A `tsibble` allows storage and manipulation of time series in R.

* It contains:

  + Measured variable(s): numbers of interest
  + An index: time information about the observation
  + Key variable(s): optional unique identifiers for each series

* It works with tidyverse functions.

## The `tsibble` index

### Example
\fontsize{12}{13}\sf

```{r tstable, cache=TRUE}
library(tsibble)
y <- tsibble(year = 2012:2016,
  y = c(123,39,78,52,110), index = year)
y
```

## The `tsibble` index

\begin{block}{}
For observations more frequent than once per year, we need to use a time class function on the index.
\end{block}
\fontsize{12}{13}\sf


```{r tstablemonth, echo=FALSE}
z <- tibble(Month = paste(2019, month.abb[1:5]), Observation = c(50, 23, 34, 30, 25))
#knitr::kable(z, booktabs=TRUE)
```

```{r tstablemonth2}
z
```

## The `tsibble` index

\begin{block}{}
For observations more frequent than once per year, we need to use a time class function on the index.
\end{block}
\fontsize{12}{13}\sf

```{r month-tsibble}
z %>%
  mutate(Month = yearmonth(Month)) %>%
  as_tsibble(index = Month)
```

## The `tsibble` index

Common time index variables can be created with these functions:

###
```{r tstable2, echo=FALSE}
tribble(
  ~ `Frequency`, ~ Function,
  "Annual", "`start:end`",
  "Quarterly", "`yearquarter()`",
  "Monthly", "`yearmonth()`",
  "Weekly", "`yearweek()`",
  "Daily", "`as_date()`, `ymd()`",
  "Sub-daily", "`as_datetime()`"
) %>%
  knitr::kable(booktabs=TRUE)
```

# Working with `tsibble` objects

## Australian Pharmaceutical Benefits Scheme

\full{pills}

## Australian Pharmaceutical Benefits Scheme
\begin{block}{}
The \alert{Pharmaceutical Benefits Scheme} (PBS) is the Australian government drugs subsidy scheme.
\end{block}
\pause\fontsize{13.3}{15}\sf

  * Many drugs bought from pharmacies are subsidised to allow more equitable access to modern drugs.
  * The cost to government is determined by the number and types of drugs purchased. Currently nearly 1\% of GDP.
  * The total cost is budgeted based on forecasts of drug usage.
  * Costs are disaggregated by drug type (ATC1 x`r length(unique(PBS$ATC1))` / ATC2 `r length(unique(PBS$ATC2))`), concession category (x`r length(unique(PBS$Concession))`) and patient type (x`r length(unique(PBS$Type))`), giving $84\times2\times2=`r 84*2*2`$ time series.

## Working with `tsibble` objects {-}
\fontsize{8}{10}\sf

```{r wide, include=FALSE}
options(width=78)
```

```{r pbs1, dependson='wide'}
PBS
```


## Working with `tsibble` objects {-}
\fontsize{12}{14}\sf

We can use the `filter()` function to select rows.

\fontsize{8}{10}\sf

```{r pbs2}
PBS %>%
  filter(ATC2=="A10")
```

## Working with `tsibble` objects {-}
\fontsize{12}{14}\sf

We can use the `select()` function to select columns.

\fontsize{8}{10}\sf

```r
PBS %>%
  filter(ATC2=="A10") %>%
  select(Cost)
```

```
Selecting index: "Month"
Error: The result is not a valid tsibble.
Do you need `as_tibble()` to work with data frame?
```

\vspace*{10cm}

## Working with `tsibble` objects {-}
\fontsize{12}{14}\sf

We can use the `select()` function to select columns.

\fontsize{8}{10}\sf

```{r pbs3}
PBS %>%
  filter(ATC2=="A10") %>%
  select(Month, Concession, Type, Cost)
```

## Working with `tsibble` objects {-}
\fontsize{12}{14}\sf

We can use the `summarise()` function to summarise over keys.

\fontsize{8}{10}\sf

```{r pbs4}
PBS %>%
  filter(ATC2=="A10") %>%
  select(Month, Concession, Type, Cost) %>%
  summarise(TotalC = sum(Cost))
```

## Working with `tsibble` objects {-}
\fontsize{12}{14}\sf

We can use the `mutate()` function to create new variables.

\fontsize{8}{10}\sf

```{r pbs5}
PBS %>%
  filter(ATC2=="A10") %>%
  select(Month, Concession, Type, Cost) %>%
  summarise(TotalC = sum(Cost)) %>%
  mutate(Cost = TotalC/1e6)
```

## Working with `tsibble` objects {-}
\fontsize{12}{14}\sf

We can use the `mutate()` function to create new variables.

\fontsize{8}{10}\sf

```{r pbs6}
PBS %>%
  filter(ATC2=="A10") %>%
  select(Month, Concession, Type, Cost) %>%
  summarise(TotalC = sum(Cost)) %>%
  mutate(Cost = TotalC/1e6) -> a10
```

```{r a10, echo=FALSE}
a10
```

```{r narrow, include=FALSE}
options(width=60)
```

# Create a tsibble from a csv

## Create a tsibble from a csv
\fontsize{13}{14}\sf


```{r prison, echo=FALSE, warning=FALSE, message=FALSE}
prison <- readr::read_csv("../data/prison_population.csv")
prison %>%
  head(15) %>%
  knitr::kable(booktabs=TRUE)
prison <- prison %>%
  mutate(Quarter = yearquarter(date)) %>%
  select(-date) %>%
  as_tsibble(index=Quarter, key=c(state, gender, legal, indigenous))
```

## Read a csv file and convert to a tsibble {-}
\fontsize{10}{11}\sf

```{r prison2, echo=TRUE, eval=FALSE}
prison <- readr::read_csv("prison_population.csv") %>%
  mutate(Quarter = yearquarter(date)) %>%
  select(-date) %>%
  as_tsibble(index=Quarter,
    key=c(state, gender, legal, indigenous))
```

```{r prison3, dependson=prison}
prison
```

### The seasonal period {-}
<!-- TODO: Also detail problematic periods (months in daily data). -->

Some graphics and some models will use the seasonal period of the data. The seasonal period\index{frequency}\index{period} is the number of observations before the seasonal pattern repeats. In most cases, this will be automatically detected using the time index variable.

Some common periods for different time intervals are shown in the table below:

```{r freqtable, echo=FALSE, message=FALSE}
  intervals <- list(
  Quarters = tsibble::new_interval(quarter = 1),
  Months = tsibble::new_interval(month = 1),
  Weeks = tsibble::new_interval(week = 1),
  Days = tsibble::new_interval(day = 1),
  Hours = tsibble::new_interval(hour = 1),
  Minutes = tsibble::new_interval(minute = 1),
  Seconds = tsibble::new_interval(second = 1)
)

intervals %>%
  purrr::map(common_periods) %>%
  purrr::map(as.list) %>%
  purrr::map_dfr(as_tibble, .id = "Data") %>%
  purrr::set_names(., stringr::str_to_sentence(colnames(.))) %>%
  select(Data, Minute, Hour, Day, Week, Year) %>%
  mutate_all(format, scientific = FALSE, nsmall = 2) %>%
  mutate_all(~ gsub(".00", "", ., fixed = TRUE)) %>%
  mutate_all(~ gsub("   NA", "", ., fixed=TRUE)) %>%
  knitr::kable(booktabs=TRUE)
```

For quarterly, monthly and weekly data, there is only one seasonal period --- the number of observations within each year. Actually, there are not $52$ weeks in a year, but $365.25/7 = `r sprintf("%.2f",365.25/7)`$ on average, allowing for a leap year every fourth year. Approximating seasonal periods to integers can be useful as many seasonal terms in models only support integer seasonal periods.

If the data is observed more than once per week, then there is often more than one seasonal pattern in the data. For example, data with daily observations\index{daily data} might have weekly (period$=7$) or annual (period$=365.25$) seasonal patterns. Similarly, data that are observed every minute might have hourly (period$=60$), daily (period$=24\times60=1440$), weekly (period$=24\times60\times7=10080$) and annual seasonality (period$=24\times60\times365.25=525960$).\index{hourly data}\index{multiple seasonality}\index{sub-daily data}

More complicated (and unusual) seasonal patterns can be specified using the `period()` function in the lubridate package.

# Time plots

## Time plots

```{r a10-print, echo = TRUE, dependson="a10"}
a10
```

## Time plots

\small

```{r a10-plot, echo=TRUE, dependson="a10"}
a10 %>% autoplot(Cost)
```

## Time plots

\small

```{r a10-plot2, echo=TRUE, dependson="a10"}
a10 %>% autoplot(Cost) +
  ylab("$ million") + xlab("Year") +
  ggtitle("Antidiabetic drug sales")
```

## Time plots

\small

```{r, echo=TRUE,}
ansett
```

## Time plots

\small

```{r, echo=TRUE,}
ansett %>%
  filter(Airports=="MEL-SYD", Class=="Economy") %>%
  autoplot(Passengers)
```

## Your turn

- Create plots of the following time series: Bricks from `aus_production`, Lynx from `pelt`, Google from `gafa_stock`
- Use `help()` to find out about the data in each series.
- For the last plot, modify the axis labels and title.

## Are time plots best?

\fontsize{12}{14}\sf

```{r maxtemp, echo=FALSE}
maxtemp <- vic_elec %>%
  index_by(Day = lubridate::date(Time)) %>%
  summarise(
    Temperature = max(Temperature),
    Demand = sum(Demand),
    Holiday = any(Holiday)
  )
```

```{r maxtemp1, warning=FALSE, message=FALSE, dependson="maxtemp"}
maxtemp %>%
  autoplot(Temperature) +
  xlab("Week") + ylab("Max temperature")
```

## Are time plots best?

\fontsize{12}{14}\sf

```{r maxtemp2, warning=FALSE, message=FALSE, dependson="maxtemp"}
maxtemp %>%
  ggplot(aes(x = Day, y = Temperature)) +
  geom_point() +
  xlab("Week") + ylab("Max temperature")
```

## Are time plots best?

```{r maxtemp3, warning=FALSE, message=FALSE, echo=FALSE, dependson="maxtemp"}
maxtemp %>%
  ggplot(aes(x = Day, y = 1)) +
  geom_tile(aes(fill = Temperature)) +
  scale_fill_gradient2(
    low = "navy",
    mid = "yellow",
   high = "red", midpoint=28) +
  ylab("") + scale_y_discrete(expand=c(0,0))
```

## Are time plots best?

\full{TemperatureBlanket}

